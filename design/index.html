
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An educational content workflow orchestration tool for LLM integration">
      
      
        <meta name="author" content="Curriculum Curator Team">
      
      
        <link rel="canonical" href="https://teaching-repositories.github.io/curriculum-curator/design/">
      
      
        <link rel="prev" href="../adr/0005-interactive-interfaces/">
      
      
        <link rel="next" href="../design-addendum/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Original Design - Curriculum Curator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Curriculum Curator" class="md-header__button md-logo" aria-label="Curriculum Curator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Curriculum Curator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Original Design
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/teaching-repositories/curriculum-curator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    teaching-repositories/curriculum-curator
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../getting-started/installation/" class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/interactive-mode/" class="md-tabs__link">
          
  
  
    
  
  User Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../concepts/architecture/" class="md-tabs__link">
          
  
  
    
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../api/overview/" class="md-tabs__link">
          
  
  
    
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../development/contributing/" class="md-tabs__link">
          
  
  
    
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../adr/" class="md-tabs__link">
          
  
  
    
  
  Architecture Decisions

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
    
  
  Design Documents

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Curriculum Curator" class="md-nav__button md-logo" aria-label="Curriculum Curator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Curriculum Curator
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/teaching-repositories/curriculum-curator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    teaching-repositories/curriculum-curator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/interactive-mode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interactive Mode
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/workflow-builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflow Builder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/workflow-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflow Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/prompt-editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Editor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/mvp-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MVP Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/cli-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/remediation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Remediation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/pypi-publishing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Publishing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../adr/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Architecture Decisions
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Architecture Decisions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/0001-record-architecture-decisions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0001
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/0002-validation-remediation-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0002
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/0003-workflow-configuration-format/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0003
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/0004-interactive-workflow-builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0004
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/0005-interactive-interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0005
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Design Documents
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Design Documents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Original Design
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Original Design
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1. Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-philosophy" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Philosophy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      3. System Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-prompt-registry-filesystem-based-with-yaml-front-matter" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Prompt Registry (Filesystem-based with YAML Front Matter)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Prompt Registry (Filesystem-based with YAML Front Matter)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#storage-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prompt-format" class="md-nav__link">
    <span class="md-ellipsis">
      Prompt Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-llm-integration-layer-broker-based" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 LLM Integration Layer (Broker-based)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 LLM Integration Layer (Broker-based)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-content-transformation-layer" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Content Transformation Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-workflow-engine" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Workflow Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-validation-framework" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Validation Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-user-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      4. User Interfaces
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. User Interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-command-line-interface-cli" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Command Line Interface (CLI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-python-api" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Python API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-future-user-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Future User Interfaces
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 Future User Interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-terminal-user-interface-tui" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.1 Terminal User Interface (TUI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.2 Web Interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Web Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-retry-mechanisms" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Retry Mechanisms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-graceful-degradation" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 Graceful Degradation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-structured-logging" class="md-nav__link">
    <span class="md-ellipsis">
      5.4 Structured Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-user-feedback" class="md-nav__link">
    <span class="md-ellipsis">
      5.5 User Feedback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-persistence-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      6. Data Persistence Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Data Persistence Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-output-management" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Output Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-persistence-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Persistence Interfaces
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-workflow-process" class="md-nav__link">
    <span class="md-ellipsis">
      7. Workflow Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Workflow Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-standard-course-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Standard Course Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-example-workflow-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Example Workflow Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-custom-workflow-steps" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 Custom Workflow Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-implementation-approach" class="md-nav__link">
    <span class="md-ellipsis">
      8. Implementation Approach
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Implementation Approach">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Project Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-development-tools" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 Development Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-deployment-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Deployment Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Deployment Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-package-installation" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 Package Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-docker-container" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 Docker Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-github-releases" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 GitHub Releases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95-local-development" class="md-nav__link">
    <span class="md-ellipsis">
      9.5 Local Development
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-component-interaction-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      10. Component Interaction Diagram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-benefits-of-this-approach" class="md-nav__link">
    <span class="md-ellipsis">
      11. Benefits of This Approach
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      12. Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design-addendum/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Addendum
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1. Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-philosophy" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Philosophy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      3. System Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-prompt-registry-filesystem-based-with-yaml-front-matter" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Prompt Registry (Filesystem-based with YAML Front Matter)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Prompt Registry (Filesystem-based with YAML Front Matter)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#storage-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prompt-format" class="md-nav__link">
    <span class="md-ellipsis">
      Prompt Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-llm-integration-layer-broker-based" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 LLM Integration Layer (Broker-based)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 LLM Integration Layer (Broker-based)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-content-transformation-layer" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Content Transformation Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-workflow-engine" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Workflow Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-validation-framework" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Validation Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-user-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      4. User Interfaces
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. User Interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-command-line-interface-cli" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Command Line Interface (CLI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-python-api" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Python API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-future-user-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Future User Interfaces
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 Future User Interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-terminal-user-interface-tui" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.1 Terminal User Interface (TUI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.2 Web Interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Web Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-retry-mechanisms" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Retry Mechanisms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-graceful-degradation" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 Graceful Degradation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-structured-logging" class="md-nav__link">
    <span class="md-ellipsis">
      5.4 Structured Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-user-feedback" class="md-nav__link">
    <span class="md-ellipsis">
      5.5 User Feedback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-data-persistence-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      6. Data Persistence Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Data Persistence Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-output-management" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Output Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-persistence-interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Persistence Interfaces
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-workflow-process" class="md-nav__link">
    <span class="md-ellipsis">
      7. Workflow Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Workflow Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-standard-course-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Standard Course Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-example-workflow-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Example Workflow Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-custom-workflow-steps" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 Custom Workflow Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-implementation-approach" class="md-nav__link">
    <span class="md-ellipsis">
      8. Implementation Approach
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Implementation Approach">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Project Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-development-tools" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 Development Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8.4 Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-deployment-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Deployment Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Deployment Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-package-installation" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 Package Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-docker-container" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 Docker Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-github-releases" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 GitHub Releases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      9.4 Documentation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95-local-development" class="md-nav__link">
    <span class="md-ellipsis">
      9.5 Local Development
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-component-interaction-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      10. Component Interaction Diagram
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-benefits-of-this-approach" class="md-nav__link">
    <span class="md-ellipsis">
      11. Benefits of This Approach
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      12. Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Original Design</h1>

<h2 id="1-introduction">1. Introduction</h2>
<p>CurriculumCurator is an educational content workflow orchestration tool designed to streamline the creation of comprehensive curriculum materials through Large Language Model (LLM) integration. This document outlines the architectural design, component interactions, and implementation considerations for the system.</p>
<h2 id="2-core-philosophy">2. Core Philosophy</h2>
<p>CurriculumCurator is designed around two fundamental principles:</p>
<ol>
<li><strong>Prompt-centric Content Generation</strong>: All content is derived from well-designed prompts managed within the system.</li>
<li><strong>Workflow-driven Process</strong>: Content creation follows configurable, automated educational workflows.</li>
</ol>
<h2 id="3-system-architecture">3. System Architecture</h2>
<h3 id="31-prompt-registry-filesystem-based-with-yaml-front-matter">3.1 Prompt Registry (Filesystem-based with YAML Front Matter)</h3>
<p>The foundation of the system is a managed collection of prompts stored directly as files with embedded metadata.</p>
<h4 id="storage-structure">Storage Structure</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>prompts/
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  course/
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    overview.txt
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    faq.txt
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  module/
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    slides.txt
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    worksheet.txt
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  assessment/
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    mcq.txt
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    short-answer.txt
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    fill-blank.txt
</code></pre></div>
<h4 id="prompt-format">Prompt Format</h4>
<p>Each prompt file includes YAML Front Matter for metadata:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generates multiple-choice questions for a module.</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nt">requires</span><span class="p">:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module_title</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key_concepts</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">num_questions</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">assessment</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mcq</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.1</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="nn">---</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="l l-Scalar l-Scalar-Plain">Generate {num_questions} multiple-choice questions about the key concepts ({key_concepts}) for the module titled &quot;{module_title}&quot;.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="l l-Scalar l-Scalar-Plain">Each question should have one correct answer and three plausible distractors.</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="l l-Scalar l-Scalar-Plain">Format the output as Markdown list items.</span>
</code></pre></div>
<h4 id="implementation">Implementation</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span> <span class="nn">frontmatter</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">class</span> <span class="nc">PromptRegistry</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_cache</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="k">def</span> <span class="nf">get_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_path</span><span class="p">):</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a prompt by its path relative to the base path.&quot;&quot;&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="k">if</span> <span class="n">prompt_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_cache</span><span class="p">:</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_cache</span><span class="p">[</span><span class="n">prompt_path</span><span class="p">]</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">/</span> <span class="n">prompt_path</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prompt not found: </span><span class="si">{</span><span class="n">prompt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="n">prompt_data</span> <span class="o">=</span> <span class="n">frontmatter</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_cache</span><span class="p">[</span><span class="n">prompt_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt_data</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">prompt_data</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="p">}</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_cache</span><span class="p">[</span><span class="n">prompt_path</span><span class="p">]</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>    <span class="k">def</span> <span class="nf">list_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List all prompts, optionally filtered by tag.&quot;&quot;&quot;</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.txt&quot;</span><span class="p">):</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="n">relative_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>            <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>                <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">))</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>                    <span class="n">prompt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">))</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>                    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">prompt_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>                        <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">))</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>                    <span class="k">continue</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="k">return</span> <span class="n">prompts</span>
</code></pre></div>
<h3 id="32-llm-integration-layer-broker-based">3.2 LLM Integration Layer (Broker-based)</h3>
<p>A flexible interface for interacting with various LLM providers using LiteLLM as the broker.</p>
<h4 id="configuration">Configuration</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">llm</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">default_provider</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ollama&quot;</span><span class="w">  </span><span class="c1"># Fallback provider</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">providers</span><span class="p">:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nt">anthropic</span><span class="p">:</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(ANTHROPIC_API_KEY)&quot;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;claude-3-haiku&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.75</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">        </span><span class="nt">claude-3-haiku</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">        </span><span class="nt">claude-3-opus</span><span class="p">:</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">          </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">            </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15.00</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">75.00</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="nt">openai</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(OPENAI_API_KEY)&quot;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-3.5-turbo&quot;</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.50</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.50</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="nt">gpt-3.5-turbo</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">        </span><span class="nt">gpt-4-turbo</span><span class="p">:</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">          </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">            </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.00</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.00</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">    </span><span class="nt">ollama</span><span class="p">:</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">      </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:11434&quot;</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llama3&quot;</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">        </span><span class="nt">llama3</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="w">        </span><span class="nt">mistral</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">    </span><span class="nt">groq</span><span class="p">:</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(GROQ_API_KEY)&quot;</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llama3-8b-8192&quot;</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.10</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.30</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">        </span><span class="nt">llama3-8b-8192</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="w">    </span><span class="nt">gemini</span><span class="p">:</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(GOOGLE_API_KEY)&quot;</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gemini-pro&quot;</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.50</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.50</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="w">        </span><span class="nt">gemini-pro</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</code></pre></div>
<h4 id="implementation_1">Implementation</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span> <span class="nn">litellm</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">import</span> <span class="nn">backoff</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">class</span> <span class="nc">LLMRequestError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised for errors in LLM requests.&quot;&quot;&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="k">pass</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="k">class</span> <span class="nc">LLMRequest</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">workflow_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_id</span> <span class="o">=</span> <span class="n">workflow_id</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step_name</span> <span class="o">=</span> <span class="n">step_name</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_tokens</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="k">class</span> <span class="nc">LLMManager</span><span class="p">:</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_workflow_id</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_step_name</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="c1"># Configure API keys from environment variables</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="k">for</span> <span class="n">provider</span><span class="p">,</span> <span class="n">provider_config</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>            <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;env(&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">api_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>                <span class="n">env_var</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>                <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>                <span class="k">if</span> <span class="n">provider</span> <span class="o">!=</span> <span class="s2">&quot;ollama&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing API key for </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">env_var</span><span class="o">=</span><span class="n">env_var</span><span class="p">)</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>    <span class="k">def</span> <span class="nf">_resolve_model_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve model alias to provider and model.&quot;&quot;&quot;</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="k">if</span> <span class="n">model_alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="n">default_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;default_provider&quot;</span><span class="p">]</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>            <span class="n">default_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">][</span><span class="n">default_provider</span><span class="p">][</span><span class="s2">&quot;default_model&quot;</span><span class="p">]</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>            <span class="k">return</span> <span class="n">default_provider</span><span class="p">,</span> <span class="n">default_model</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>        <span class="c1"># Check if alias is in provider/model format</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">model_alias</span><span class="p">:</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="n">provider</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">model_alias</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span> <span class="ow">and</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>                <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">][</span><span class="n">provider</span><span class="p">][</span><span class="s2">&quot;models&quot;</span><span class="p">]):</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>                <span class="k">return</span> <span class="n">provider</span><span class="p">,</span> <span class="n">model</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="c1"># Otherwise, assume it&#39;s a direct model reference and search for it</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="k">for</span> <span class="n">provider</span><span class="p">,</span> <span class="n">provider_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>            <span class="k">if</span> <span class="n">model_alias</span> <span class="ow">in</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;models&quot;</span><span class="p">]:</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>                <span class="k">return</span> <span class="n">provider</span><span class="p">,</span> <span class="n">model_alias</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>        <span class="c1"># Fall back to default if not found</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="n">default_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;default_provider&quot;</span><span class="p">]</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>        <span class="n">default_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">][</span><span class="n">default_provider</span><span class="p">][</span><span class="s2">&quot;default_model&quot;</span><span class="p">]</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>            <span class="s2">&quot;model_alias_not_found&quot;</span><span class="p">,</span> 
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>            <span class="n">model_alias</span><span class="o">=</span><span class="n">model_alias</span><span class="p">,</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>            <span class="n">using_default</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_provider</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">default_model</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>        <span class="p">)</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>        <span class="k">return</span> <span class="n">default_provider</span><span class="p">,</span> <span class="n">default_model</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>    <span class="k">def</span> <span class="nf">_calculate_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate cost based on token counts and configured rates.&quot;&quot;&quot;</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>        <span class="n">provider_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">provider</span><span class="p">]</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>        <span class="n">model_config</span> <span class="o">=</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;models&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>        <span class="c1"># Get costs, checking model-specific, then provider default</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="n">input_cost</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cost_per_1k_tokens&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>            <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;cost_per_1k_tokens&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>        <span class="p">)</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="n">output_cost</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cost_per_1k_tokens&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>            <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;cost_per_1k_tokens&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>        <span class="p">)</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>        <span class="c1"># Calculate total cost</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>        <span class="n">request</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>            <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_cost</span> <span class="o">+</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>            <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">output_cost</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>        <span class="p">)</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">cost</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>    <span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>        <span class="n">backoff</span><span class="o">.</span><span class="n">expo</span><span class="p">,</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>        <span class="p">(</span><span class="ne">Exception</span><span class="p">),</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>        <span class="n">max_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>        <span class="n">jitter</span><span class="o">=</span><span class="n">backoff</span><span class="o">.</span><span class="n">full_jitter</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>    <span class="p">)</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">model_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate text using the specified model or defaults.&quot;&quot;&quot;</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>        <span class="c1"># Resolve provider and model from alias or defaults</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>        <span class="n">provider</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_model_alias</span><span class="p">(</span><span class="n">model_alias</span><span class="p">)</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>        <span class="c1"># Create request object for tracking</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>        <span class="n">request</span> <span class="o">=</span> <span class="n">LLMRequest</span><span class="p">(</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> 
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>            <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span> 
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>            <span class="n">workflow_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workflow_id</span><span class="p">,</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>            <span class="n">step_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step_name</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>        <span class="p">)</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>            <span class="s2">&quot;llm_request_started&quot;</span><span class="p">,</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>            <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>            <span class="n">workflow_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workflow_id</span><span class="p">,</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>            <span class="n">step_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step_name</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>        <span class="p">)</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>            <span class="c1"># Get provider-specific configuration</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>            <span class="n">provider_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">][</span><span class="s2">&quot;providers&quot;</span><span class="p">][</span><span class="n">provider</span><span class="p">]</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>            <span class="c1"># Configure API key</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>            <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;env(&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">api_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>                <span class="n">env_var</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>                <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>            <span class="c1"># Configure base URL if needed (for Ollama, etc.)</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>            <span class="n">base_url</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>            <span class="c1"># Use LiteLLM to make the actual request</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">litellm</span><span class="o">.</span><span class="n">acompletion</span><span class="p">(</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>                <span class="n">model</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>                <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>                <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>                <span class="o">**</span><span class="n">params</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>            <span class="p">)</span>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>            <span class="n">request</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>            <span class="n">request</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>            <span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">prompt_tokens</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>            <span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>                <span class="s2">&quot;llm_request_completed&quot;</span><span class="p">,</span>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>                <span class="n">input_tokens</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>                <span class="n">output_tokens</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>                <span class="n">workflow_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workflow_id</span><span class="p">,</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>                <span class="n">step_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step_name</span>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>            <span class="p">)</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>            <span class="n">request</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>            <span class="n">request</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>                <span class="s2">&quot;llm_request_failed&quot;</span><span class="p">,</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>                <span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>                <span class="n">workflow_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workflow_id</span><span class="p">,</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>                <span class="n">step_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step_name</span>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>            <span class="p">)</span>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>            <span class="k">raise</span> <span class="n">LLMRequestError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>            <span class="n">request</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">:</span>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cost</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">completion</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>    <span class="k">def</span> <span class="nf">generate_usage_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a usage report for the specified workflow and/or step.&quot;&quot;&quot;</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>        <span class="c1"># Filter history by workflow_id and step_name if provided</span>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> 
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">workflow_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">workflow_id</span> <span class="o">==</span> <span class="n">workflow_id</span><span class="p">)</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>                <span class="ow">and</span> <span class="p">(</span><span class="n">step_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">step_name</span> <span class="o">==</span> <span class="n">step_name</span><span class="p">)]</span>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>        <span class="c1"># Group by provider and model</span>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>        <span class="n">by_model</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_model</span><span class="p">:</span>
<a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>                <span class="n">by_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>                    <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>                    <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>                    <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>                    <span class="s2">&quot;avg_duration&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>                <span class="p">}</span>
<a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>
<a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">by_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
<a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a>                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a>            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
<a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;input_tokens&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">input_tokens</span> <span class="ow">or</span> <span class="mi">0</span>
<a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a>                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;output_tokens&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">output_tokens</span> <span class="ow">or</span> <span class="mi">0</span>
<a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">cost</span> <span class="ow">or</span> <span class="mi">0</span>
<a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;avg_duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;avg_duration&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">/</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
<a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>
<a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>        <span class="c1"># Calculate totals</span>
<a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a>        <span class="n">totals</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a>            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">by_model</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
<a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a>            <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;input_tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">by_model</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
<a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a>            <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;output_tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">by_model</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
<a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">by_model</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
<a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a>            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">by_model</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
<a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a>        <span class="p">}</span>
<a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a>
<a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>            <span class="s2">&quot;by_model&quot;</span><span class="p">:</span> <span class="n">by_model</span><span class="p">,</span>
<a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a>            <span class="s2">&quot;totals&quot;</span><span class="p">:</span> <span class="n">totals</span><span class="p">,</span>
<a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a>            <span class="s2">&quot;workflow_id&quot;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
<a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a>            <span class="s2">&quot;step_name&quot;</span><span class="p">:</span> <span class="n">step_name</span><span class="p">,</span>
<a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="33-content-transformation-layer">3.3 Content Transformation Layer</h3>
<p>Parses and structures raw LLM outputs.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">import</span> <span class="nn">markdown</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">class</span> <span class="nc">ContentTransformer</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="k">pass</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_content</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="n">transformation_rules</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform raw LLM output into the desired format.&quot;&quot;&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>            <span class="k">return</span> <span class="n">raw_content</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_list_items</span><span class="p">(</span><span class="n">raw_content</span><span class="p">)</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_json</span><span class="p">(</span><span class="n">raw_content</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markdown_to_html</span><span class="p">(</span><span class="n">raw_content</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="c1"># Default to returning the raw content</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="k">return</span> <span class="n">raw_content</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    <span class="k">def</span> <span class="nf">_extract_list_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract list items from markdown content.&quot;&quot;&quot;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>            <span class="c1"># Match Markdown list items (both - and * style)</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*[-*]\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="c1"># Match numbered list items</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*\d+\.\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="k">return</span> <span class="n">items</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>    <span class="k">def</span> <span class="nf">_extract_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract JSON from the content.&quot;&quot;&quot;</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="c1"># Find content between triple backticks and json</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```(?:json)?\n([\s\S]*?)\n```&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>                <span class="k">pass</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>        <span class="c1"># Try parsing the entire content as JSON</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="k">pass</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>        <span class="c1"># Return empty dict if no valid JSON found</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>        <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>    <span class="k">def</span> <span class="nf">_markdown_to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert markdown to HTML.&quot;&quot;&quot;</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>        <span class="k">return</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>    <span class="k">def</span> <span class="nf">extract_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">section_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract sections from content based on markdown headings.&quot;&quot;&quot;</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>        <span class="k">if</span> <span class="n">section_markers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>            <span class="c1"># Default to extracting sections by headings</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>            <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>            <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>            <span class="n">current_content</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>                <span class="n">heading_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(#{1,6})\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>                <span class="k">if</span> <span class="n">heading_match</span><span class="p">:</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>                    <span class="c1"># Save previous section if exists</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>                    <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>                        <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_content</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>                    <span class="c1"># Start new section</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>                    <span class="n">current_section</span> <span class="o">=</span> <span class="n">heading_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>                    <span class="n">current_content</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>                    <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>                        <span class="n">current_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>            <span class="c1"># Save the last section</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>            <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>                <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_content</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>            <span class="k">return</span> <span class="n">sections</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>            <span class="c1"># Use custom section markers</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>            <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>            <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">section_markers</span><span class="p">:</span>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;### </span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*</span><span class="se">\\</span><span class="s2">n([</span><span class="se">\\</span><span class="s2">s</span><span class="se">\\</span><span class="s2">S]*?)(?=### [^#]|$)&quot;</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>                    <span class="n">sections</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>            <span class="k">return</span> <span class="n">sections</span>
</code></pre></div>
<h3 id="34-workflow-engine">3.4 Workflow Engine</h3>
<p>Orchestrates the sequence of content generation, validation, and remediation steps.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span> <span class="nn">uuid</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="k">class</span> <span class="nc">WorkflowError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised for errors in workflow execution.&quot;&quot;&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="k">pass</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="k">class</span> <span class="nc">WorkflowStep</span><span class="p">:</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">,</span> <span class="n">llm_manager</span><span class="p">,</span> <span class="n">content_transformer</span><span class="p">):</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute this workflow step.&quot;&quot;&quot;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses must implement execute()&quot;</span><span class="p">)</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="k">class</span> <span class="nc">PromptStep</span><span class="p">(</span><span class="n">WorkflowStep</span><span class="p">):</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">,</span> <span class="n">llm_manager</span><span class="p">,</span> <span class="n">content_transformer</span><span class="p">):</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a prompt-based step.&quot;&quot;&quot;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="c1"># Get prompt</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>        <span class="n">prompt_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_path</span><span class="p">:</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing prompt path for step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>            <span class="n">prompt_data</span> <span class="o">=</span> <span class="n">prompt_registry</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">(</span><span class="n">prompt_path</span><span class="p">)</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>        <span class="c1"># Check required variables</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="n">required_vars</span> <span class="o">=</span> <span class="n">prompt_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="n">missing_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">required_vars</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="p">]</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="k">if</span> <span class="n">missing_vars</span><span class="p">:</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>                <span class="sa">f</span><span class="s2">&quot;Missing required variables for prompt </span><span class="si">{</span><span class="n">prompt_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>            <span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span class="c1"># Fill in prompt template</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>            <span class="n">prompt_content</span> <span class="o">=</span> <span class="n">prompt_data</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>            <span class="n">filled_prompt</span> <span class="o">=</span> <span class="n">prompt_content</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error formatting prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="c1"># Get LLM response</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>        <span class="n">model_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;llm_model_alias&quot;</span><span class="p">)</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">llm_manager</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">filled_prompt</span><span class="p">,</span> <span class="n">model_alias</span><span class="p">)</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="c1"># Transform content if requested</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>        <span class="n">output_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_format&quot;</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">)</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>        <span class="n">transformation_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transformation_rules&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>            <span class="n">transformed_content</span> <span class="o">=</span> <span class="n">content_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>                <span class="n">response</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="n">transformation_rules</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>            <span class="p">)</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content transformation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>        <span class="c1"># Store in context under output_variable</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>        <span class="n">output_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variable&quot;</span><span class="p">)</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>        <span class="k">if</span> <span class="n">output_variable</span><span class="p">:</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>            <span class="n">context</span><span class="p">[</span><span class="n">output_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed_content</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>        <span class="c1"># Store usage information in context</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>        <span class="n">usage_stats</span> <span class="o">=</span> <span class="n">llm_manager</span><span class="o">.</span><span class="n">generate_usage_report</span><span class="p">(</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>            <span class="n">workflow_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">),</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>            <span class="n">step_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>        <span class="p">)</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>        <span class="n">context</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;usage_stats&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;usage_stats&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage_stats</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>        <span class="k">return</span> <span class="n">transformed_content</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a><span class="k">class</span> <span class="nc">ValidationStep</span><span class="p">(</span><span class="n">WorkflowStep</span><span class="p">):</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">,</span> <span class="n">llm_manager</span><span class="p">,</span> <span class="n">content_transformer</span><span class="p">):</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a validation step.&quot;&quot;&quot;</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>        <span class="c1"># Implementation for validation steps</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>        <span class="k">pass</span>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a><span class="k">class</span> <span class="nc">OutputStep</span><span class="p">(</span><span class="n">WorkflowStep</span><span class="p">):</span>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">,</span> <span class="n">llm_manager</span><span class="p">,</span> <span class="n">content_transformer</span><span class="p">):</span>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute an output generation step.&quot;&quot;&quot;</span>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>        <span class="c1"># Implementation for output generation (e.g., using Pandoc)</span>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>        <span class="k">pass</span>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a><span class="k">class</span> <span class="nc">Workflow</span><span class="p">:</span>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">,</span> <span class="n">llm_manager</span><span class="p">,</span> <span class="n">content_transformer</span><span class="p">):</span>
<a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_registry</span> <span class="o">=</span> <span class="n">prompt_registry</span>
<a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span> <span class="o">=</span> <span class="n">llm_manager</span>
<a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content_transformer</span> <span class="o">=</span> <span class="n">content_transformer</span>
<a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a>
<a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a>    <span class="k">def</span> <span class="nf">_create_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_config</span><span class="p">):</span>
<a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a workflow step from configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>        <span class="n">step_type</span> <span class="o">=</span> <span class="n">step_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">)</span>
<a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>        <span class="n">step_name</span> <span class="o">=</span> <span class="n">step_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>
<a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>        <span class="k">if</span> <span class="n">step_type</span> <span class="o">==</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span>
<a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>            <span class="k">return</span> <span class="n">PromptStep</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">step_config</span><span class="p">)</span>
<a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>        <span class="k">elif</span> <span class="n">step_type</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
<a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>            <span class="k">return</span> <span class="n">ValidationStep</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">step_config</span><span class="p">)</span>
<a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>        <span class="k">elif</span> <span class="n">step_type</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
<a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>            <span class="k">return</span> <span class="n">OutputStep</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">step_config</span><span class="p">)</span>
<a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown step type: </span><span class="si">{</span><span class="n">step_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>
<a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>    <span class="k">def</span> <span class="nf">_initialize_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new session or load an existing one.&quot;&quot;&quot;</span>
<a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>
<a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>        <span class="c1"># Create session directory</span>
<a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session_base_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;.curriculum_curator/sessions&quot;</span><span class="p">))</span>
<a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>        <span class="n">session_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>
<a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">=</span> <span class="n">session_dir</span>
<a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>        <span class="k">return</span> <span class="n">session_id</span>
<a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>
<a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>    <span class="k">def</span> <span class="nf">_save_session_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the current session state to disk.&quot;&quot;&quot;</span>
<a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span><span class="p">:</span>
<a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>            <span class="k">return</span>
<a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>
<a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>        <span class="c1"># Save config used</span>
<a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>            <span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>
<a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>        <span class="c1"># Save session state (exclude large content)</span>
<a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>        <span class="n">sanitized_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
<a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
<a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10000</span>
<a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>        <span class="p">}</span>
<a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>
<a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;session.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>            <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sanitized_context</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>
<a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>        <span class="c1"># Append to prompt history</span>
<a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;prompt_history.jsonl&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
<a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">workflow_id</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">):</span>
<a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>                    <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>                    <span class="n">json_record</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a>                        <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
<a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a>                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>                        <span class="s2">&quot;step_name&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">step_name</span><span class="p">,</span>
<a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a>                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>                        <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
<a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>                        <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
<a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>                        <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
<a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a>                        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span>
<a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a>                        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="k">else</span> <span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a>                    <span class="p">}</span>
<a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_record</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a>
<a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the specified workflow.&quot;&quot;&quot;</span>
<a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a>        <span class="c1"># Get workflow configuration</span>
<a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>        <span class="n">workflow_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflows&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
<a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_config</span><span class="p">:</span>
<a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Workflow not found: </span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>
<a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>        <span class="c1"># Initialize context</span>
<a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">initial_context</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_name</span>
<a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>
<a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>        <span class="c1"># Initialize session</span>
<a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>        <span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
<a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a>
<a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>        <span class="c1"># Configure LLM manager with workflow context</span>
<a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span><span class="o">.</span><span class="n">current_workflow_id</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">]</span>
<a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>
<a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>        <span class="c1"># Get workflow steps</span>
<a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a>        <span class="n">step_configs</span> <span class="o">=</span> <span class="n">workflow_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">step_configs</span><span class="p">:</span>
<a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No steps defined for workflow: </span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>
<a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>        <span class="c1"># Execute steps</span>
<a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step_configs</span><span class="p">):</span>
<a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>                <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_step</span><span class="p">(</span><span class="n">step_config</span><span class="p">)</span>
<a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a>                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;current_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;current_step_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a>
<a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>                    <span class="s2">&quot;workflow_step_started&quot;</span><span class="p">,</span>
<a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>                    <span class="n">workflow_name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span>
<a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>                    <span class="n">workflow_id</span><span class="o">=</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">],</span>
<a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>                    <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>                    <span class="n">step_index</span><span class="o">=</span><span class="n">i</span>
<a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>                <span class="p">)</span>
<a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a>
<a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span><span class="o">.</span><span class="n">current_step_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a>
<a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">step</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a>                        <span class="n">context</span><span class="p">,</span> 
<a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_registry</span><span class="p">,</span>
<a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span><span class="p">,</span>
<a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">content_transformer</span>
<a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>                    <span class="p">)</span>
<a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a>                    <span class="n">results</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a>
<a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a>                        <span class="s2">&quot;workflow_step_completed&quot;</span><span class="p">,</span>
<a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a>                        <span class="n">workflow_name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span>
<a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a>                        <span class="n">workflow_id</span><span class="o">=</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">],</span>
<a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a>                        <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a>                        <span class="n">step_index</span><span class="o">=</span><span class="n">i</span>
<a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a>                    <span class="p">)</span>
<a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
<a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a>                        <span class="s2">&quot;workflow_step_failed&quot;</span><span class="p">,</span>
<a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a>                        <span class="n">workflow_name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span>
<a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a>                        <span class="n">workflow_id</span><span class="o">=</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">],</span>
<a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a>                        <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>                        <span class="n">step_index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
<a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a>                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a>                    <span class="p">)</span>
<a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a>                    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-6-240" name="__codelineno-6-240" href="#__codelineno-6-240"></a>                    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;failed_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-6-241" name="__codelineno-6-241" href="#__codelineno-6-241"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_session_state</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-6-242" name="__codelineno-6-242" href="#__codelineno-6-242"></a>                    <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-243" name="__codelineno-6-243" href="#__codelineno-6-243"></a>
<a id="__codelineno-6-244" name="__codelineno-6-244" href="#__codelineno-6-244"></a>                <span class="c1"># Save session state after each step</span>
<a id="__codelineno-6-245" name="__codelineno-6-245" href="#__codelineno-6-245"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_session_state</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-6-246" name="__codelineno-6-246" href="#__codelineno-6-246"></a>
<a id="__codelineno-6-247" name="__codelineno-6-247" href="#__codelineno-6-247"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-6-248" name="__codelineno-6-248" href="#__codelineno-6-248"></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-6-249" name="__codelineno-6-249" href="#__codelineno-6-249"></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-6-250" name="__codelineno-6-250" href="#__codelineno-6-250"></a>
<a id="__codelineno-6-251" name="__codelineno-6-251" href="#__codelineno-6-251"></a>            <span class="c1"># Generate final usage report</span>
<a id="__codelineno-6-252" name="__codelineno-6-252" href="#__codelineno-6-252"></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;final_usage_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_manager</span><span class="o">.</span><span class="n">generate_usage_report</span><span class="p">(</span>
<a id="__codelineno-6-253" name="__codelineno-6-253" href="#__codelineno-6-253"></a>                <span class="n">workflow_id</span><span class="o">=</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;workflow_id&quot;</span><span class="p">]</span>
<a id="__codelineno-6-254" name="__codelineno-6-254" href="#__codelineno-6-254"></a>            <span class="p">)</span>
<a id="__codelineno-6-255" name="__codelineno-6-255" href="#__codelineno-6-255"></a>
<a id="__codelineno-6-256" name="__codelineno-6-256" href="#__codelineno-6-256"></a>            <span class="c1"># Save final session state</span>
<a id="__codelineno-6-257" name="__codelineno-6-257" href="#__codelineno-6-257"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_session_state</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-6-258" name="__codelineno-6-258" href="#__codelineno-6-258"></a>
<a id="__codelineno-6-259" name="__codelineno-6-259" href="#__codelineno-6-259"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-6-260" name="__codelineno-6-260" href="#__codelineno-6-260"></a>            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
<a id="__codelineno-6-261" name="__codelineno-6-261" href="#__codelineno-6-261"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
<a id="__codelineno-6-262" name="__codelineno-6-262" href="#__codelineno-6-262"></a>            <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span>
<a id="__codelineno-6-263" name="__codelineno-6-263" href="#__codelineno-6-263"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="35-validation-framework">3.5 Validation Framework</h3>
<p>Ensures content quality and consistency through a suite of validators that can be applied to generated content.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">class</span> <span class="nc">ValidationIssue</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">severity</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suggestion</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="n">severity</span>  <span class="c1"># &quot;error&quot;, &quot;warning&quot;, &quot;info&quot;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>  <span class="c1"># E.g., &quot;section_name&quot;, &quot;line:42&quot;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suggestion</span> <span class="o">=</span> <span class="n">suggestion</span>  <span class="c1"># Optional suggestion for fixing</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="k">class</span> <span class="nc">Validator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate content and return a list of validation issues.&quot;&quot;&quot;</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="k">pass</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="k">class</span> <span class="nc">SimilarityValidator</span><span class="p">(</span><span class="n">Validator</span><span class="p">):</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for content similarity across sections or files.&quot;&quot;&quot;</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>            <span class="c1"># If content is a dictionary of sections</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>            <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>            <span class="n">texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>            <span class="c1"># If content is a list of documents</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>            <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;document_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))]</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>            <span class="n">texts</span> <span class="o">=</span> <span class="n">content</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>            <span class="c1"># Single document, nothing to compare</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>        <span class="c1"># Calculate similarity matrix</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s1">&#39;english&#39;</span><span class="p">)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>            <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>            <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">tfidf_matrix</span><span class="p">)</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>                <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to calculate similarity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>                <span class="kc">None</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>            <span class="p">))</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>            <span class="k">return</span> <span class="n">issues</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>        <span class="c1"># Check for similarities above threshold</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)):</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>                <span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>                    <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>                        <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>                        <span class="sa">f</span><span class="s2">&quot;High similarity (</span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) between &#39;</span><span class="si">{</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">sections</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sections</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>                        <span class="s2">&quot;Consider merging or revising the content to reduce duplication.&quot;</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>                    <span class="p">))</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>        <span class="k">return</span> <span class="n">issues</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a><span class="k">class</span> <span class="nc">StructureValidator</span><span class="p">(</span><span class="n">Validator</span><span class="p">):</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">required_sections</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required_sections&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_sections</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_sections&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">section_pattern</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section_pattern&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;^#{1,3}\s+(.+))</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the structure of the content.&quot;&quot;&quot;</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>        <span class="c1"># Extract sections using regex</span>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>        <span class="c1"># Check minimum number of sections</span>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sections</span><span class="p">:</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>                <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>                <span class="sa">f</span><span class="s2">&quot;Content has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections, but at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sections</span><span class="si">}</span><span class="s2"> are required&quot;</span><span class="p">,</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>                <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>                <span class="s2">&quot;Add more sections to fulfill the structural requirements.&quot;</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>            <span class="p">))</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>        <span class="c1"># Check required sections</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>        <span class="k">for</span> <span class="n">required_section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_sections</span><span class="p">:</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>                <span class="k">if</span> <span class="n">required_section</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>                    <span class="k">break</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>                    <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>                    <span class="sa">f</span><span class="s2">&quot;Required section &#39;</span><span class="si">{</span><span class="n">required_section</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">,</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>                    <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>                    <span class="sa">f</span><span class="s2">&quot;Add a &#39;</span><span class="si">{</span><span class="n">required_section</span><span class="si">}</span><span class="s2">&#39; section to the content.&quot;</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>                <span class="p">))</span>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>        <span class="k">return</span> <span class="n">issues</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a><span class="k">class</span> <span class="nc">ReadabilityValidator</span><span class="p">(</span><span class="n">Validator</span><span class="p">):</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates content for readability metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_flesch_reading_ease</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_flesch_reading_ease&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># Higher is easier to read</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_avg_sentence_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_avg_sentence_length&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check readability of content.&quot;&quot;&quot;</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>        <span class="c1"># Split content into sentences (basic implementation)</span>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>        <span class="n">sentences</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[.!?]+\s+&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>        <span class="c1"># Calculate average sentence length</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>        <span class="k">if</span> <span class="n">sentences</span><span class="p">:</span>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>            <span class="n">total_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\w+\b&#39;</span><span class="p">,</span> <span class="n">sentence</span><span class="p">))</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">)</span>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>            <span class="n">avg_sentence_length</span> <span class="o">=</span> <span class="n">total_words</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>            <span class="k">if</span> <span class="n">avg_sentence_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_avg_sentence_length</span><span class="p">:</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>                    <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>                    <span class="sa">f</span><span class="s2">&quot;Average sentence length (</span><span class="si">{</span><span class="n">avg_sentence_length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> words) exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_avg_sentence_length</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>                    <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>                    <span class="s2">&quot;Consider breaking longer sentences into shorter ones for improved readability.&quot;</span>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>                <span class="p">))</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>        <span class="c1"># TODO: Implement Flesch Reading Ease calculation</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>        <span class="c1"># This would typically involve syllable counting which is more complex</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>        <span class="k">return</span> <span class="n">issues</span>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a><span class="k">class</span> <span class="nc">ValidationManager</span><span class="p">:</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages and runs multiple validators on content.</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a><span class="sd">    This class coordinates the execution of multiple validation checks</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a><span class="sd">    on generated content, collecting and organizing the results.</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validators</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_validators</span><span class="p">()</span>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>    <span class="k">def</span> <span class="nf">_initialize_validators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize validators from configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>        <span class="n">validator_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="k">if</span> <span class="s2">&quot;similarity&quot;</span> <span class="ow">in</span> <span class="n">validator_configs</span><span class="p">:</span>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="s2">&quot;similarity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimilarityValidator</span><span class="p">(</span><span class="n">validator_configs</span><span class="p">[</span><span class="s2">&quot;similarity&quot;</span><span class="p">])</span>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>        <span class="k">if</span> <span class="s2">&quot;structure&quot;</span> <span class="ow">in</span> <span class="n">validator_configs</span><span class="p">:</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StructureValidator</span><span class="p">(</span><span class="n">validator_configs</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">])</span>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>        <span class="k">if</span> <span class="s2">&quot;readability&quot;</span> <span class="ow">in</span> <span class="n">validator_configs</span><span class="p">:</span>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="s2">&quot;readability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadabilityValidator</span><span class="p">(</span><span class="n">validator_configs</span><span class="p">[</span><span class="s2">&quot;readability&quot;</span><span class="p">])</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">validator_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run specified validators on content.&quot;&quot;&quot;</span>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>        <span class="n">all_issues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>
<a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>        <span class="c1"># Determine which validators to run</span>
<a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>        <span class="k">if</span> <span class="n">validator_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>            <span class="n">validators_to_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>            <span class="n">validators_to_run</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">validator_names</span> 
<a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validators</span>
<a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>            <span class="p">]</span>
<a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>
<a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>        <span class="c1"># Run each validator</span>
<a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>        <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="n">validators_to_run</span><span class="p">:</span>
<a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>            <span class="n">validator_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>                <span class="s2">&quot;running_validator&quot;</span><span class="p">,</span>
<a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>                <span class="n">validator</span><span class="o">=</span><span class="n">validator_name</span><span class="p">,</span>
<a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>                <span class="n">content_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a>                <span class="n">content_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
<a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>            <span class="p">)</span>
<a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a>
<a id="__codelineno-7-206" name="__codelineno-7-206" href="#__codelineno-7-206"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-207" name="__codelineno-7-207" href="#__codelineno-7-207"></a>                <span class="n">issues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-7-208" name="__codelineno-7-208" href="#__codelineno-7-208"></a>                <span class="n">all_issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>
<a id="__codelineno-7-209" name="__codelineno-7-209" href="#__codelineno-7-209"></a>
<a id="__codelineno-7-210" name="__codelineno-7-210" href="#__codelineno-7-210"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-7-211" name="__codelineno-7-211" href="#__codelineno-7-211"></a>                    <span class="s2">&quot;validator_completed&quot;</span><span class="p">,</span>
<a id="__codelineno-7-212" name="__codelineno-7-212" href="#__codelineno-7-212"></a>                    <span class="n">validator</span><span class="o">=</span><span class="n">validator_name</span><span class="p">,</span>
<a id="__codelineno-7-213" name="__codelineno-7-213" href="#__codelineno-7-213"></a>                    <span class="n">issues_found</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>
<a id="__codelineno-7-214" name="__codelineno-7-214" href="#__codelineno-7-214"></a>                <span class="p">)</span>
<a id="__codelineno-7-215" name="__codelineno-7-215" href="#__codelineno-7-215"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-7-216" name="__codelineno-7-216" href="#__codelineno-7-216"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
<a id="__codelineno-7-217" name="__codelineno-7-217" href="#__codelineno-7-217"></a>                    <span class="s2">&quot;validator_failed&quot;</span><span class="p">,</span>
<a id="__codelineno-7-218" name="__codelineno-7-218" href="#__codelineno-7-218"></a>                    <span class="n">validator</span><span class="o">=</span><span class="n">validator_name</span><span class="p">,</span>
<a id="__codelineno-7-219" name="__codelineno-7-219" href="#__codelineno-7-219"></a>                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-7-220" name="__codelineno-7-220" href="#__codelineno-7-220"></a>                <span class="p">)</span>
<a id="__codelineno-7-221" name="__codelineno-7-221" href="#__codelineno-7-221"></a>
<a id="__codelineno-7-222" name="__codelineno-7-222" href="#__codelineno-7-222"></a>                <span class="n">all_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationIssue</span><span class="p">(</span>
<a id="__codelineno-7-223" name="__codelineno-7-223" href="#__codelineno-7-223"></a>                    <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<a id="__codelineno-7-224" name="__codelineno-7-224" href="#__codelineno-7-224"></a>                    <span class="sa">f</span><span class="s2">&quot;Validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-225" name="__codelineno-7-225" href="#__codelineno-7-225"></a>                    <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-226" name="__codelineno-7-226" href="#__codelineno-7-226"></a>                    <span class="kc">None</span>
<a id="__codelineno-7-227" name="__codelineno-7-227" href="#__codelineno-7-227"></a>                <span class="p">))</span>
<a id="__codelineno-7-228" name="__codelineno-7-228" href="#__codelineno-7-228"></a>
<a id="__codelineno-7-229" name="__codelineno-7-229" href="#__codelineno-7-229"></a>        <span class="k">return</span> <span class="n">all_issues</span>
</code></pre></div>
<h2 id="4-user-interfaces">4. User Interfaces</h2>
<p>CurriculumCurator provides multiple ways for users to interact with the system.</p>
<h3 id="41-command-line-interface-cli">4.1 Command Line Interface (CLI)</h3>
<p>The CLI is implemented using Typer for command definition and argument parsing, combined with Rich for formatted terminal output and progress display. This combination provides a modern, user-friendly command-line experience with minimal dependencies.</p>
<p>The primary interface for running workflows and managing prompts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">import</span> <span class="nn">sys</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kn">import</span> <span class="nn">typer</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="kn">from</span> <span class="nn">rich</span> <span class="kn">import</span> <span class="nb">print</span> <span class="c1"># Optional: Use rich for nicer printing if desired</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="c1"># Assuming CurriculumCurator is importable (adjust path if needed)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1"># from curriculum_curator.core import CurriculumCurator</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1"># Placeholder for example:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="k">class</span> <span class="nc">CurriculumCurator</span><span class="p">:</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_registry</span> <span class="o">=</span> <span class="bp">self</span> <span class="c1"># Simplified for example</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CurriculumCurator Initialized (placeholder)&quot;</span><span class="p">)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>    <span class="k">def</span> <span class="nf">list_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing prompts (placeholder)&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        <span class="c1"># Replace with actual logic from PromptRegistry</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_with_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">]</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;course/overview.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;module/slides.txt&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;prompt_with_some_tag.txt&quot;</span><span class="p">]</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running workflow (placeholder)&quot;</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>        <span class="c1"># Replace with actual async WorkflowEngine logic</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># Simulate async work</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;output_files&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;output/</span><span class="si">{</span><span class="n">session_id</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;new_session&#39;</span><span class="si">}</span><span class="s2">/content.html&quot;</span><span class="p">}},</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>            <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="s2">&quot;new_session_123&quot;</span><span class="p">,</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>                <span class="s2">&quot;final_usage_report&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>                    <span class="s2">&quot;by_model&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ollama/llama3&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>                    <span class="s2">&quot;totals&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>                <span class="p">}</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>            <span class="p">}</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="p">}</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">resume_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">from_step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming workflow (placeholder)&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">from_step</span><span class="o">=</span><span class="n">from_step</span><span class="p">)</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>        <span class="c1"># Replace with actual async WorkflowEngine logic</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># Simulate async work</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>             <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;output_files&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pdf&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;output/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">/content.pdf&quot;</span><span class="p">}},</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>             <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>             <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;final_usage_report&quot;</span><span class="p">:</span> <span class="p">{}}</span> <span class="c1"># Simplified</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>         <span class="p">}</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="c1"># End Placeholder</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span> <span class="c1"># Assuming structlog is configured elsewhere</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="c1"># Create the Typer app</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;CurriculumCurator CLI - Orchestrate educational content workflows.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="c1"># --- Helper Functions ---</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to configuration file.&quot;</span><span class="p">)):</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads configuration from YAML file. (Executed before commands needing it if used as dependency)&quot;&quot;&quot;</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error:[/bold red] Configuration file not found at </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error:[/bold red] Failed to load or parse configuration file </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="k">def</span> <span class="nf">parse_vars</span><span class="p">(</span><span class="n">var_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--var&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Variables in key=value format. Can be used multiple times.&quot;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses the --var options into a dictionary.&quot;&quot;&quot;</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a>    <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a>    <span class="k">if</span> <span class="n">var_list</span><span class="p">:</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a>            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a>                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a>                <span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Warning:[/yellow] Ignoring improperly formatted variable: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a>    <span class="k">return</span> <span class="n">variables</span>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a><span class="k">def</span> <span class="nf">_print_result</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_json</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to print workflow results.&quot;&quot;&quot;</span>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a>    <span class="k">if</span> <span class="n">output_json</span><span class="p">:</span>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a>        <span class="c1"># Output JSON result</span>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
<a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a>        <span class="c1"># Print summary using Rich</span>
<a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]Workflow completed successfully.[/green]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session ID: [bold cyan]</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/bold cyan]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a>
<a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a>        <span class="n">output_files</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_files&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a>        <span class="k">if</span> <span class="n">output_files</span><span class="p">:</span>
<a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Output files:[/bold]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a>            <span class="k">for</span> <span class="n">format_name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">output_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a>
<a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a>        <span class="c1"># Print usage statistics</span>
<a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a>        <span class="n">usage</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_usage_report&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a>        <span class="k">if</span> <span class="n">usage</span><span class="p">:</span>
<a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Token Usage Summary:[/bold]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a>            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;by_model&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [yellow]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">[/yellow]:&quot;</span><span class="p">)</span>
<a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Requests: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Input tokens: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Output tokens: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;output_tokens&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Cost: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Requires cost calculation implementation</span>
<a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a>
<a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a>            <span class="n">totals</span> <span class="o">=</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;totals&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a>            <span class="k">if</span> <span class="n">totals</span><span class="p">:</span>
<a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  [bold]Total:[/bold]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Requests: </span><span class="si">{</span><span class="n">totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Input tokens: </span><span class="si">{</span><span class="n">totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Output tokens: </span><span class="si">{</span><span class="n">totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_tokens&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Cost: $</span><span class="si">{</span><span class="n">totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Requires cost calculation implementation</span>
<a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a>
<a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a>
<a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a><span class="c1"># --- Typer Commands ---</span>
<a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a>
<a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a>    <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the workflow to run.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a>    <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--var&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Variables in key=value format. Can be used multiple times.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a>    <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify a session ID to use or resume.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a>    <span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to configuration file.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a>    <span class="n">output_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--output-json&quot;</span><span class="p">,</span> <span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output result as JSON.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a><span class="p">):</span>
<a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a><span class="sd">    Run a specified workflow.</span>
<a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
<a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a>    <span class="n">variables</span> <span class="o">=</span> <span class="n">parse_vars</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">CurriculumCurator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="c1"># Assuming initialization with config</span>
<a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running workflow &#39;</span><span class="si">{</span><span class="n">workflow</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
<a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">curator</span><span class="o">.</span><span class="n">run_workflow</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
<a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a>        <span class="n">_print_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_json</span><span class="p">)</span>
<a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Replace with more specific exceptions later</span>
<a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;workflow_failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error running workflow &#39;</span><span class="si">{</span><span class="n">workflow</span><span class="si">}</span><span class="s2">&#39;:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a>        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a>
<a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;list-workflows&quot;</span><span class="p">)</span>
<a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a><span class="k">def</span> <span class="nf">list_workflows_command</span><span class="p">(</span>
<a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a>    <span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to configuration file.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a><span class="p">):</span>
<a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-151" name="__codelineno-8-151" href="#__codelineno-8-151"></a><span class="sd">    List available workflows defined in the configuration file.</span>
<a id="__codelineno-8-152" name="__codelineno-8-152" href="#__codelineno-8-152"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-153" name="__codelineno-8-153" href="#__codelineno-8-153"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
<a id="__codelineno-8-154" name="__codelineno-8-154" href="#__codelineno-8-154"></a>    <span class="n">workflows</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflows&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-8-155" name="__codelineno-8-155" href="#__codelineno-8-155"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">workflows</span><span class="p">:</span>
<a id="__codelineno-8-156" name="__codelineno-8-156" href="#__codelineno-8-156"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[yellow]No workflows found in configuration.[/yellow]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-157" name="__codelineno-8-157" href="#__codelineno-8-157"></a>        <span class="k">return</span>
<a id="__codelineno-8-158" name="__codelineno-8-158" href="#__codelineno-8-158"></a>
<a id="__codelineno-8-159" name="__codelineno-8-159" href="#__codelineno-8-159"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[bold]Available workflows:[/bold]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-160" name="__codelineno-8-160" href="#__codelineno-8-160"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">workflow_config</span> <span class="ow">in</span> <span class="n">workflows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-161" name="__codelineno-8-161" href="#__codelineno-8-161"></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">workflow_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;[i]No description[/i]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-162" name="__codelineno-8-162" href="#__codelineno-8-162"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [cyan]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[/cyan]: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-163" name="__codelineno-8-163" href="#__codelineno-8-163"></a>
<a id="__codelineno-8-164" name="__codelineno-8-164" href="#__codelineno-8-164"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;list-prompts&quot;</span><span class="p">)</span>
<a id="__codelineno-8-165" name="__codelineno-8-165" href="#__codelineno-8-165"></a><span class="k">def</span> <span class="nf">list_prompts_command</span><span class="p">(</span>
<a id="__codelineno-8-166" name="__codelineno-8-166" href="#__codelineno-8-166"></a>    <span class="n">tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--tag&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Filter prompts by tag specified in YAML front matter.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-167" name="__codelineno-8-167" href="#__codelineno-8-167"></a>    <span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to configuration file.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-168" name="__codelineno-8-168" href="#__codelineno-8-168"></a><span class="p">):</span>
<a id="__codelineno-8-169" name="__codelineno-8-169" href="#__codelineno-8-169"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-170" name="__codelineno-8-170" href="#__codelineno-8-170"></a><span class="sd">    List available prompts, optionally filtering by tag.</span>
<a id="__codelineno-8-171" name="__codelineno-8-171" href="#__codelineno-8-171"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-172" name="__codelineno-8-172" href="#__codelineno-8-172"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
<a id="__codelineno-8-173" name="__codelineno-8-173" href="#__codelineno-8-173"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">CurriculumCurator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="c1"># Assuming initialization needed for registry path</span>
<a id="__codelineno-8-174" name="__codelineno-8-174" href="#__codelineno-8-174"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-175" name="__codelineno-8-175" href="#__codelineno-8-175"></a>        <span class="c1"># Assuming curator object has access to prompt_registry</span>
<a id="__codelineno-8-176" name="__codelineno-8-176" href="#__codelineno-8-176"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="n">curator</span><span class="o">.</span><span class="n">prompt_registry</span><span class="o">.</span><span class="n">list_prompts</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-8-177" name="__codelineno-8-177" href="#__codelineno-8-177"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompts</span><span class="p">:</span>
<a id="__codelineno-8-178" name="__codelineno-8-178" href="#__codelineno-8-178"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[yellow]No prompts found.[/yellow]&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; matching tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39;.&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span>
<a id="__codelineno-8-179" name="__codelineno-8-179" href="#__codelineno-8-179"></a>            <span class="k">return</span>
<a id="__codelineno-8-180" name="__codelineno-8-180" href="#__codelineno-8-180"></a>
<a id="__codelineno-8-181" name="__codelineno-8-181" href="#__codelineno-8-181"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Available prompts&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; matching tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:[/bold]&quot;</span><span class="p">)</span>
<a id="__codelineno-8-182" name="__codelineno-8-182" href="#__codelineno-8-182"></a>        <span class="k">for</span> <span class="n">prompt_path</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
<a id="__codelineno-8-183" name="__codelineno-8-183" href="#__codelineno-8-183"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">prompt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-184" name="__codelineno-8-184" href="#__codelineno-8-184"></a>
<a id="__codelineno-8-185" name="__codelineno-8-185" href="#__codelineno-8-185"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Replace with more specific exceptions later</span>
<a id="__codelineno-8-186" name="__codelineno-8-186" href="#__codelineno-8-186"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;list_prompts_failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-8-187" name="__codelineno-8-187" href="#__codelineno-8-187"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error listing prompts:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-188" name="__codelineno-8-188" href="#__codelineno-8-188"></a>        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-189" name="__codelineno-8-189" href="#__codelineno-8-189"></a>
<a id="__codelineno-8-190" name="__codelineno-8-190" href="#__codelineno-8-190"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-8-191" name="__codelineno-8-191" href="#__codelineno-8-191"></a><span class="k">def</span> <span class="nf">resume</span><span class="p">(</span>
<a id="__codelineno-8-192" name="__codelineno-8-192" href="#__codelineno-8-192"></a>    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The Session ID of the workflow to resume.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-193" name="__codelineno-8-193" href="#__codelineno-8-193"></a>    <span class="n">from_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specific step name to resume from (implementation needed).&quot;</span><span class="p">),</span>
<a id="__codelineno-8-194" name="__codelineno-8-194" href="#__codelineno-8-194"></a>    <span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to configuration file.&quot;</span><span class="p">),</span>
<a id="__codelineno-8-195" name="__codelineno-8-195" href="#__codelineno-8-195"></a>    <span class="n">output_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--output-json&quot;</span><span class="p">,</span> <span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output result as JSON.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-196" name="__codelineno-8-196" href="#__codelineno-8-196"></a><span class="p">):</span>
<a id="__codelineno-8-197" name="__codelineno-8-197" href="#__codelineno-8-197"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-198" name="__codelineno-8-198" href="#__codelineno-8-198"></a><span class="sd">    Resume a previously interrupted workflow session (basic placeholder).</span>
<a id="__codelineno-8-199" name="__codelineno-8-199" href="#__codelineno-8-199"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-200" name="__codelineno-8-200" href="#__codelineno-8-200"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
<a id="__codelineno-8-201" name="__codelineno-8-201" href="#__codelineno-8-201"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">CurriculumCurator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="c1"># Assuming initialization with config</span>
<a id="__codelineno-8-202" name="__codelineno-8-202" href="#__codelineno-8-202"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-203" name="__codelineno-8-203" href="#__codelineno-8-203"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming workflow session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
<a id="__codelineno-8-204" name="__codelineno-8-204" href="#__codelineno-8-204"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">curator</span><span class="o">.</span><span class="n">resume_workflow</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">from_step</span><span class="p">))</span>
<a id="__codelineno-8-205" name="__codelineno-8-205" href="#__codelineno-8-205"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[green]Workflow resumed successfully.[/green]&quot;</span><span class="p">)</span> <span class="c1"># Simplified message</span>
<a id="__codelineno-8-206" name="__codelineno-8-206" href="#__codelineno-8-206"></a>        <span class="n">_print_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_json</span><span class="p">)</span>
<a id="__codelineno-8-207" name="__codelineno-8-207" href="#__codelineno-8-207"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Replace with more specific exceptions later</span>
<a id="__codelineno-8-208" name="__codelineno-8-208" href="#__codelineno-8-208"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;resume_workflow_failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-8-209" name="__codelineno-8-209" href="#__codelineno-8-209"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error resuming workflow session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;:[/bold red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-210" name="__codelineno-8-210" href="#__codelineno-8-210"></a>        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-211" name="__codelineno-8-211" href="#__codelineno-8-211"></a>
<a id="__codelineno-8-212" name="__codelineno-8-212" href="#__codelineno-8-212"></a>
<a id="__codelineno-8-213" name="__codelineno-8-213" href="#__codelineno-8-213"></a><span class="c1"># --- Entry Point ---</span>
<a id="__codelineno-8-214" name="__codelineno-8-214" href="#__codelineno-8-214"></a>
<a id="__codelineno-8-215" name="__codelineno-8-215" href="#__codelineno-8-215"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-8-216" name="__codelineno-8-216" href="#__codelineno-8-216"></a>    <span class="c1"># Configure logging (basic example)</span>
<a id="__codelineno-8-217" name="__codelineno-8-217" href="#__codelineno-8-217"></a>    <span class="n">structlog</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
<a id="__codelineno-8-218" name="__codelineno-8-218" href="#__codelineno-8-218"></a>        <span class="n">processors</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-8-219" name="__codelineno-8-219" href="#__codelineno-8-219"></a>            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">add_log_level</span><span class="p">,</span>
<a id="__codelineno-8-220" name="__codelineno-8-220" href="#__codelineno-8-220"></a>            <span class="n">structlog</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">StackInfoRenderer</span><span class="p">(),</span>
<a id="__codelineno-8-221" name="__codelineno-8-221" href="#__codelineno-8-221"></a>            <span class="n">structlog</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">ConsoleRenderer</span><span class="p">(),</span>
<a id="__codelineno-8-222" name="__codelineno-8-222" href="#__codelineno-8-222"></a>        <span class="p">],</span>
<a id="__codelineno-8-223" name="__codelineno-8-223" href="#__codelineno-8-223"></a>        <span class="n">logger_factory</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">LoggerFactory</span><span class="p">(),</span>
<a id="__codelineno-8-224" name="__codelineno-8-224" href="#__codelineno-8-224"></a>        <span class="n">cache_logger_on_first_use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-8-225" name="__codelineno-8-225" href="#__codelineno-8-225"></a>    <span class="p">)</span>
<a id="__codelineno-8-226" name="__codelineno-8-226" href="#__codelineno-8-226"></a>    <span class="c1"># Run the Typer app</span>
<a id="__codelineno-8-227" name="__codelineno-8-227" href="#__codelineno-8-227"></a>    <span class="n">app</span><span class="p">()</span>
</code></pre></div>
<h3 id="42-python-api">4.2 Python API</h3>
<p>For programmatic use and integration into other Python applications.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Example usage of the Python API</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span> <span class="nn">curriculum_curator</span> <span class="kn">import</span> <span class="n">CurriculumCurator</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">generate_course_materials</span><span class="p">():</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="c1"># Initialize with configuration</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">CurriculumCurator</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="c1"># Define course parameters</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="n">course_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        <span class="s2">&quot;course_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Introduction to Python Programming&quot;</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="s2">&quot;learning_objectives&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="s2">&quot;Understand basic Python syntax&quot;</span><span class="p">,</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>            <span class="s2">&quot;Write and execute simple programs&quot;</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>            <span class="s2">&quot;Use control structures and functions&quot;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="p">],</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="s2">&quot;num_modules&quot;</span><span class="p">:</span> <span class="mi">4</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="p">}</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="c1"># Run the course generation workflow</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">curator</span><span class="o">.</span><span class="n">run_workflow</span><span class="p">(</span><span class="s2">&quot;standard_course&quot;</span><span class="p">,</span> <span class="n">course_params</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    <span class="c1"># Process the results</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Course materials generated successfully.&quot;</span><span class="p">)</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output files:&quot;</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="k">for</span> <span class="nb">format</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_files&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>    <span class="c1"># Get token usage info</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>    <span class="n">usage</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_usage_report&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total cost: $</span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totals&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="c1"># Run the example</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>    <span class="kn">import</span> <span class="nn">asyncio</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">generate_course_materials</span><span class="p">())</span>
</code></pre></div>
<h3 id="43-future-user-interfaces">4.3 Future User Interfaces</h3>
<h4 id="431-terminal-user-interface-tui">4.3.1 Terminal User Interface (TUI)</h4>
<p>A planned interactive terminal interface using libraries like textual or rich.</p>
<h4 id="432-web-interface">4.3.2 Web Interface</h4>
<h4 id="web-interface">Web Interface</h4>
<p>A web-based dashboard for monitoring workflows and managing content, built with:</p>
<ul>
<li><strong>FastHTML</strong>: Server-side rendered (SSR) Python web framework based on Starlette</li>
<li><strong>HTMX</strong>: Handles dynamic content updates without complex JavaScript</li>
<li><strong>Pico CSS</strong>: Lightweight CSS framework included with FastHTML by default</li>
</ul>
<p>This stack allows maintaining Python as the single programming language while still delivering a responsive, interactive user experience. The server-side rendering approach simplifies deployment and improves initial page load performance.</p>
<p>Example implementation sketch:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span> <span class="nn">fasthtml.common</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">app</span><span class="p">,</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">fast_app</span><span class="p">()</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nd">@rt</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Render the main dashboard.&quot;&quot;&quot;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="k">return</span> <span class="n">Titled</span><span class="p">(</span><span class="s2">&quot;CurriculumCurator Dashboard&quot;</span><span class="p">,</span> 
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;workflows&quot;</span><span class="p">),</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;usage-stats&quot;</span><span class="p">)</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="p">)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="nd">@rt</span><span class="p">(</span><span class="s2">&quot;/workflows&quot;</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;List available workflows.&quot;&quot;&quot;</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">get_curator_instance</span><span class="p">()</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>    <span class="n">workflows</span> <span class="o">=</span> <span class="n">curator</span><span class="o">.</span><span class="n">list_workflows</span><span class="p">()</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>    <span class="n">workflow_list</span> <span class="o">=</span> <span class="n">Ul</span><span class="p">()</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="n">workflows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;No description&quot;</span><span class="p">)</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>        <span class="n">workflow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Li</span><span class="p">(</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>            <span class="n">A</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/workflows/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>            <span class="n">P</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>        <span class="p">))</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    <span class="k">return</span> <span class="n">Titled</span><span class="p">(</span><span class="s2">&quot;Available Workflows&quot;</span><span class="p">,</span> <span class="n">workflow_list</span><span class="p">)</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="nd">@rt</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Display workflow details and execution options.&quot;&quot;&quot;</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">get_curator_instance</span><span class="p">()</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>    <span class="n">workflow</span> <span class="o">=</span> <span class="n">curator</span><span class="o">.</span><span class="n">get_workflow</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>        <span class="n">H2</span><span class="p">(</span><span class="s2">&quot;Run Workflow&quot;</span><span class="p">),</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>        <span class="n">Input</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;workflow_name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workflow_name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span><span class="p">),</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>        <span class="n">Input</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;course_title&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;course_title&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Course Title&quot;</span><span class="p">),</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>        <span class="n">Textarea</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;learning_objectives&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;learning_objectives&quot;</span><span class="p">,</span> 
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>                <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Learning Objectives (one per line)&quot;</span><span class="p">),</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Start Workflow&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="p">),</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="n">hx_post</span><span class="o">=</span><span class="s2">&quot;/api/run-workflow&quot;</span><span class="p">,</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>        <span class="n">hx_target</span><span class="o">=</span><span class="s2">&quot;#execution-results&quot;</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>    <span class="p">)</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>    <span class="k">return</span> <span class="n">Titled</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Workflow: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>        <span class="n">Div</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;No description&quot;</span><span class="p">)),</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>        <span class="n">form</span><span class="p">,</span>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>        <span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;execution-results&quot;</span><span class="p">)</span>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>    <span class="p">)</span>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a><span class="nd">@rt</span><span class="p">(</span><span class="s2">&quot;/api/run-workflow&quot;</span><span class="p">)</span>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a><span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">course_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">learning_objectives</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a workflow with the provided parameters.&quot;&quot;&quot;</span>
<a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">get_curator_instance</span><span class="p">()</span>
<a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>
<a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>    <span class="c1"># Parse learning objectives into a list</span>
<a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>    <span class="n">objectives</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">learning_objectives</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>
<a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>    <span class="c1"># Set up the context with the form values</span>
<a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>        <span class="s2">&quot;course_title&quot;</span><span class="p">:</span> <span class="n">course_title</span><span class="p">,</span>
<a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>        <span class="s2">&quot;learning_objectives&quot;</span><span class="p">:</span> <span class="n">objectives</span>
<a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>    <span class="p">}</span>
<a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>
<a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>    <span class="c1"># Run the workflow asynchronously</span>
<a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>    <span class="n">session_id</span> <span class="o">=</span> <span class="n">curator</span><span class="o">.</span><span class="n">start_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>
<a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a>    <span class="c1"># Return a message with the session ID and a refresh trigger</span>
<a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a>    <span class="k">return</span> <span class="n">Div</span><span class="p">(</span>
<a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>        <span class="n">H3</span><span class="p">(</span><span class="s2">&quot;Workflow Started&quot;</span><span class="p">),</span>
<a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a>        <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session ID: </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>        <span class="n">P</span><span class="p">(</span><span class="s2">&quot;Results will appear here as they become available.&quot;</span><span class="p">),</span>
<a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>        <span class="n">hx_trigger</span><span class="o">=</span><span class="s2">&quot;load delay:2s&quot;</span><span class="p">,</span>
<a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>        <span class="n">hx_get</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/api/workflow-status/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a>        <span class="n">hx_target</span><span class="o">=</span><span class="s2">&quot;#execution-results&quot;</span>
<a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a>    <span class="p">)</span>
<a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a>
<a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a><span class="nd">@rt</span><span class="p">(</span><span class="s2">&quot;/api/workflow-status/</span><span class="si">{session_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the status of a workflow execution.&quot;&quot;&quot;</span>
<a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a>    <span class="n">curator</span> <span class="o">=</span> <span class="n">get_curator_instance</span><span class="p">()</span>
<a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a>    <span class="n">status</span> <span class="o">=</span> <span class="n">curator</span><span class="o">.</span><span class="n">get_workflow_status</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a>
<a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a>    <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]:</span>
<a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a>        <span class="c1"># Show completion details</span>
<a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span>
<a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a>            <span class="n">H3</span><span class="p">(</span><span class="s2">&quot;Workflow Completed&quot;</span><span class="p">),</span>
<a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duration: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">),</span>
<a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a>            <span class="n">H4</span><span class="p">(</span><span class="s2">&quot;Generated Files&quot;</span><span class="p">),</span>
<a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>            <span class="n">Ul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Li</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">path</span><span class="p">))</span> <span class="k">for</span> <span class="nb">format</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_files&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
<a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>            <span class="n">H4</span><span class="p">(</span><span class="s2">&quot;Usage Statistics&quot;</span><span class="p">),</span>
<a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tokens: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;usage&#39;</span><span class="p">][</span><span class="s1">&#39;total_tokens&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total cost: $</span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;usage&#39;</span><span class="p">][</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>        <span class="p">)</span>
<a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>        <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>        <span class="c1"># Show progress and trigger another refresh</span>
<a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>        <span class="n">progress</span> <span class="o">=</span> <span class="n">Div</span><span class="p">(</span>
<a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>            <span class="n">H3</span><span class="p">(</span><span class="s2">&quot;Workflow In Progress&quot;</span><span class="p">),</span>
<a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current step: </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_step&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Initializing&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>            <span class="n">P</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Progress: </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">),</span>
<a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a>            <span class="n">hx_trigger</span><span class="o">=</span><span class="s2">&quot;load delay:3s&quot;</span><span class="p">,</span>
<a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a>            <span class="n">hx_get</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/api/workflow-status/</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a>            <span class="n">hx_target</span><span class="o">=</span><span class="s2">&quot;#execution-results&quot;</span>
<a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a>        <span class="p">)</span>
<a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a>        <span class="k">return</span> <span class="n">progress</span>
<a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a>
<a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a><span class="n">serve</span><span class="p">()</span>
<a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a>
<a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a><span class="c1">## 5. Error Handling Strategy</span>
<a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a>
<a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a><span class="n">CurriculumCurator</span> <span class="n">implements</span> <span class="n">a</span> <span class="n">comprehensive</span> <span class="n">error</span> <span class="n">handling</span> <span class="n">approach</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">robustness</span> <span class="ow">in</span> <span class="n">dealing</span> <span class="k">with</span> <span class="n">various</span> <span class="n">failure</span> <span class="n">scenarios</span><span class="o">.</span>
<a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a>
<a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a><span class="c1">### 5.1 Exception Hierarchy</span>
<a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>
<a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a><span class="err">```</span><span class="n">python</span>
<a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a><span class="c1"># Core exceptions</span>
<a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a><span class="k">class</span> <span class="nc">CurriculumCuratorError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all curriculum curator errors.&quot;&quot;&quot;</span>
<a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a>    <span class="k">pass</span>
<a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a>
<a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a><span class="c1"># Component-specific exceptions</span>
<a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a><span class="k">class</span> <span class="nc">PromptError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to prompt loading and rendering.&quot;&quot;&quot;</span>
<a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a>    <span class="k">pass</span>
<a id="__codelineno-10-129" name="__codelineno-10-129" href="#__codelineno-10-129"></a>
<a id="__codelineno-10-130" name="__codelineno-10-130" href="#__codelineno-10-130"></a><span class="k">class</span> <span class="nc">LLMRequestError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-131" name="__codelineno-10-131" href="#__codelineno-10-131"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to LLM API requests.&quot;&quot;&quot;</span>
<a id="__codelineno-10-132" name="__codelineno-10-132" href="#__codelineno-10-132"></a>    <span class="k">pass</span>
<a id="__codelineno-10-133" name="__codelineno-10-133" href="#__codelineno-10-133"></a>
<a id="__codelineno-10-134" name="__codelineno-10-134" href="#__codelineno-10-134"></a><span class="k">class</span> <span class="nc">WorkflowError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-135" name="__codelineno-10-135" href="#__codelineno-10-135"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to workflow execution.&quot;&quot;&quot;</span>
<a id="__codelineno-10-136" name="__codelineno-10-136" href="#__codelineno-10-136"></a>    <span class="k">pass</span>
<a id="__codelineno-10-137" name="__codelineno-10-137" href="#__codelineno-10-137"></a>
<a id="__codelineno-10-138" name="__codelineno-10-138" href="#__codelineno-10-138"></a><span class="k">class</span> <span class="nc">ValidationError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-139" name="__codelineno-10-139" href="#__codelineno-10-139"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to content validation.&quot;&quot;&quot;</span>
<a id="__codelineno-10-140" name="__codelineno-10-140" href="#__codelineno-10-140"></a>    <span class="k">pass</span>
<a id="__codelineno-10-141" name="__codelineno-10-141" href="#__codelineno-10-141"></a>
<a id="__codelineno-10-142" name="__codelineno-10-142" href="#__codelineno-10-142"></a><span class="k">class</span> <span class="nc">RemediationError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-143" name="__codelineno-10-143" href="#__codelineno-10-143"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to content remediation.&quot;&quot;&quot;</span>
<a id="__codelineno-10-144" name="__codelineno-10-144" href="#__codelineno-10-144"></a>    <span class="k">pass</span>
<a id="__codelineno-10-145" name="__codelineno-10-145" href="#__codelineno-10-145"></a>
<a id="__codelineno-10-146" name="__codelineno-10-146" href="#__codelineno-10-146"></a><span class="k">class</span> <span class="nc">OutputError</span><span class="p">(</span><span class="n">CurriculumCuratorError</span><span class="p">):</span>
<a id="__codelineno-10-147" name="__codelineno-10-147" href="#__codelineno-10-147"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exceptions related to output production.&quot;&quot;&quot;</span>
<a id="__codelineno-10-148" name="__codelineno-10-148" href="#__codelineno-10-148"></a>    <span class="k">pass</span>
</code></pre></div>
<h3 id="52-retry-mechanisms">5.2 Retry Mechanisms</h3>
<p>CurriculumCurator uses the <code>backoff</code> library for intelligent retry of operations that might fail temporarily:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">import</span> <span class="nn">backoff</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">backoff</span><span class="o">.</span><span class="n">expo</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="p">(</span><span class="n">LLMRequestError</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">),</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">max_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="n">jitter</span><span class="o">=</span><span class="n">backoff</span><span class="o">.</span><span class="n">full_jitter</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="p">)</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">get_llm_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">model_alias</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM response with exponential backoff retries.&quot;&quot;&quot;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="c1"># Implementation</span>
</code></pre></div>
<h3 id="53-graceful-degradation">5.3 Graceful Degradation</h3>
<p>The system is designed to continue operation even when some components fail:</p>
<ol>
<li><strong>LLM Provider Fallbacks</strong>: If the primary LLM provider fails, the system can fall back to alternative providers.</li>
<li><strong>Validation Continuation</strong>: If a validator fails, the validation process continues with other validators.</li>
<li><strong>Remediation Skipping</strong>: If remediation fails, the original content is used instead.</li>
<li><strong>Output Format Alternatives</strong>: If a particular output format conversion fails, other formats are still generated.</li>
</ol>
<h3 id="54-structured-logging">5.4 Structured Logging</h3>
<p>All components use structured logging to provide detailed context for debugging:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span> <span class="nn">structlog</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># Examples of structured logging</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="s2">&quot;workflow_step_started&quot;</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">workflow_id</span><span class="o">=</span><span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;generate_overview&quot;</span><span class="p">,</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">attempt</span><span class="o">=</span><span class="mi">2</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="s2">&quot;llm_request_failed&quot;</span><span class="p">,</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">,</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;openai&quot;</span><span class="p">,</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="p">)</span>
</code></pre></div>
<h3 id="55-user-feedback">5.5 User Feedback</h3>
<p>Errors are communicated to users with clear, actionable information:</p>
<ol>
<li><strong>CLI Feedback</strong>: Error messages with suggested actions.</li>
<li><strong>API Error Responses</strong>: Structured error objects with error codes and descriptions.</li>
<li><strong>Interactive UI</strong>: Visual indicators of errors with resolution options.</li>
</ol>
<h2 id="6-data-persistence-strategy">6. Data Persistence Strategy</h2>
<p>CurriculumCurator uses a lightweight, file-based approach to data persistence.</p>
<h3 id="61-session-management">6.1 Session Management</h3>
<p>Each workflow execution creates a session with the following structure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>.curriculum_curator/
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>  sessions/
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    20240405-123456/
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>      config.yaml      # Copy of configuration used
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>      session.json     # Record of steps executed and their status
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>      prompt_history.jsonl  # Record of prompts sent and responses
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>      context.json     # Context variables at the end of execution
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>      usage_report.json  # Token usage and cost information
</code></pre></div>
<p>This approach offers several benefits:
- No database dependency
- Easy inspection and debugging
- Simple session resumption
- Historical record for billing and analysis</p>
<h3 id="62-output-management">6.2 Output Management</h3>
<p>Generated content is stored in an output directory structure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>output/
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  20240405-123456/     # Timestamp-based subdirectory
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    content.md         # Intermediate Markdown content
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    metadata.yaml      # Content metadata
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    content.html       # HTML output
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    content.pdf        # PDF output
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    content.docx       # DOCX output
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    slides.html        # Presentation slides
</code></pre></div>
<p>This approach allows:
- Clean organization of outputs
- Multiple format versions of the same content
- Preservation of intermediate formats
- Easy sharing of output directories</p>
<h3 id="63-persistence-interfaces">6.3 Persistence Interfaces</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span> <span class="nc">PersistenceManager</span><span class="p">:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages data persistence for curriculum curator.&quot;&quot;&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;persistence_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;.curriculum_curator&quot;</span><span class="p">))</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;sessions&quot;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="k">def</span> <span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new session directory and return the session ID.&quot;&quot;&quot;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>            <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>            <span class="kn">import</span> <span class="nn">uuid</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="n">session_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        <span class="k">return</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session_dir</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="k">def</span> <span class="nf">save_session_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the current session state to disk.&quot;&quot;&quot;</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="c1"># Save context (excluding large content)</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>        <span class="n">sanitized_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">))</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10000</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="p">}</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;context.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>            <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sanitized_context</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the configuration used for this session.&quot;&quot;&quot;</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>            <span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>    <span class="k">def</span> <span class="nf">append_prompt_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a prompt request to the prompt history.&quot;&quot;&quot;</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;prompt_history.jsonl&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>            <span class="n">json_record</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>                <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>                <span class="s2">&quot;step_name&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">step_name</span><span class="p">,</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>                <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>                <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="k">else</span> <span class="n">request</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>            <span class="p">}</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_record</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>    <span class="k">def</span> <span class="nf">save_usage_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">usage_report</span><span class="p">):</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the usage report for this session.&quot;&quot;&quot;</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;usage_report.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>            <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">usage_report</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>    <span class="k">def</span> <span class="nf">load_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a session state from disk.&quot;&quot;&quot;</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span> <span class="o">/</span> <span class="n">session_id</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session not found: </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>        <span class="c1"># Load context</span>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>        <span class="n">context_file</span> <span class="o">=</span> <span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;context.json&quot;</span>
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>        <span class="k">if</span> <span class="n">context_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">context_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>                <span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a>                <span class="n">context</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a>        <span class="c1"># Load config</span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a>        <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>        <span class="n">config_file</span> <span class="o">=</span> <span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>        <span class="k">if</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>                <span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>                <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>            <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>        <span class="p">}</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a>    <span class="k">def</span> <span class="nf">list_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List all available sessions.&quot;&quot;&quot;</span>
<a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
</code></pre></div>
<h2 id="7-workflow-process">7. Workflow Process</h2>
<p>The educational content workflow follows a structured sequence that can be customized via configuration.</p>
<h3 id="71-standard-course-workflow">7.1 Standard Course Workflow</h3>
<p>A typical course generation workflow includes the following steps:</p>
<ol>
<li><strong>Course Planning</strong>:</li>
<li>Define course topic and learning objectives</li>
<li>Establish module structure</li>
<li>
<p>Set the target audience and difficulty level</p>
</li>
<li>
<p><strong>Content Generation</strong>:</p>
</li>
<li>Generate course overview document</li>
<li>Create slide decks for each module</li>
<li>Develop worksheets for hands-on activities</li>
<li>
<p>Compile FAQs for common questions</p>
</li>
<li>
<p><strong>Assessment Creation</strong>:</p>
</li>
<li>Design multiple-choice questions</li>
<li>Craft short answer questions</li>
<li>
<p>Develop fill-in-the-blank exercises</p>
</li>
<li>
<p><strong>Validation &amp; Remediation</strong>:</p>
</li>
<li>Check content similarity across modules</li>
<li>Validate structure against requirements</li>
<li>Assess educational quality and readability</li>
<li>
<p>Apply automated fixes for identified issues</p>
</li>
<li>
<p><strong>Output Production</strong>:</p>
</li>
<li>Convert to HTML for web viewing</li>
<li>Generate PDFs for printing</li>
<li>Create DOCX for editing</li>
<li>Build slide presentations</li>
</ol>
<h3 id="72-example-workflow-configuration">7.2 Example Workflow Configuration</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">workflows</span><span class="p">:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nt">standard_course</span><span class="p">:</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Standard</span><span class="nv"> </span><span class="s">course</span><span class="nv"> </span><span class="s">generation</span><span class="nv"> </span><span class="s">workflow&quot;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate_course_overview</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prompt</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="nt">prompt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">course/overview.txt</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">        </span><span class="nt">llm_model_alias</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default_smart</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="nt">output_variable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">course_overview_md</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">        </span><span class="nt">output_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">raw</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate_module_outlines</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prompt</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">        </span><span class="nt">prompt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module/outline.txt</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">        </span><span class="nt">llm_model_alias</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default_smart</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">        </span><span class="nt">output_variable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module_outlines_json</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">        </span><span class="nt">output_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">json</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate_module_slides</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loop</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">        </span><span class="nt">loop_variable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">        </span><span class="nt">loop_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module_outlines_json</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">        </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate_slides</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prompt</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">            </span><span class="nt">prompt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module/slides.txt</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">            </span><span class="nt">llm_model_alias</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default_smart</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">            </span><span class="nt">output_variable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;module_slides_${module.id}&quot;</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">            </span><span class="nt">output_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">raw</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validate_content</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validation</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">        </span><span class="nt">validators</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">similarity</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">structure</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">readability</span><span class="p p-Indicator">]</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">        </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">course_overview_md</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;module_slides_*&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remediate_content</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remediation</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">        </span><span class="nt">remediators</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">content_merger</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">sentence_splitter</span><span class="p p-Indicator">]</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">        </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">course_overview_md</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;module_slides_*&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate_output</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="w">        </span><span class="nt">formats</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">html</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pdf</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">docx</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">slides</span><span class="p p-Indicator">]</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="w">        </span><span class="nt">content_variable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">course_overview_md</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="w">          </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${course_title}&quot;</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="w">          </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;CurriculumCurator&quot;</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">          </span><span class="nt">date</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${current_date}&quot;</span>
</code></pre></div>
<h3 id="73-custom-workflow-steps">7.3 Custom Workflow Steps</h3>
<p>The workflow engine supports several types of steps:</p>
<ol>
<li><strong>Prompt Steps</strong>: Generate content using LLM prompts</li>
<li><strong>Validation Steps</strong>: Check content quality and consistency</li>
<li><strong>Remediation Steps</strong>: Fix issues identified during validation</li>
<li><strong>Output Steps</strong>: Convert content to desired formats</li>
<li><strong>Loop Steps</strong>: Repeat a sequence of steps for each item in a collection</li>
<li><strong>Conditional Steps</strong>: Execute steps based on conditions</li>
<li><strong>Custom Steps</strong>: User-defined steps for specific needs</li>
</ol>
<h2 id="8-implementation-approach">8. Implementation Approach</h2>
<h3 id="81-project-structure">8.1 Project Structure</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>curriculum_curator/
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>  __init__.py
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>  core.py               # Main CurriculumCurator class
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>  cli.py                # Command-line interface
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>  prompt/
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    __init__.py
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    registry.py         # Prompt registry implementation
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>  llm/
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    __init__.py
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    manager.py          # LLM integration layer
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>  content/
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    __init__.py
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    transformer.py      # Content transformation utilities
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>  workflow/
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    __init__.py
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    engine.py           # Workflow orchestration
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    steps.py            # Step implementations
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>  validation/
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>    __init__.py
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>    manager.py          # Validation coordination
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>    validators/         # Individual validator implementations
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>      __init__.py
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>      similarity.py
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>      structure.py
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>      readability.py
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>  remediation/
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>    __init__.py
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>    manager.py          # Remediation coordination
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>    remediators/        # Individual remediator implementations
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>      __init__.py
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>      content_merger.py
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>      sentence_splitter.py
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>  output/
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>    __init__.py
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>    manager.py          # Output generation
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>  persistence/
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>    __init__.py
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>    manager.py          # Data persistence
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>  utils/
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>    __init__.py
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>    logging.py          # Logging configuration
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>    exceptions.py       # Exception hierarchy
</code></pre></div>
<h3 id="82-dependencies">8.2 Dependencies</h3>
<p>The following external dependencies are used:</p>
<ul>
<li><strong>LiteLLM</strong>: For LLM provider integration</li>
<li><strong>python-frontmatter</strong>: For parsing YAML front matter in prompt files</li>
<li><strong>PyYAML</strong>: For configuration loading and saving</li>
<li><strong>structlog</strong>: For structured logging</li>
<li><strong>backoff</strong>: For retry mechanics</li>
<li><strong>scikit-learn</strong>: For content similarity calculations</li>
<li><strong>Pandoc</strong>: External dependency for format conversion</li>
<li><strong>FastHTML</strong>: For building the web interface backend with server-side rendering</li>
<li><strong>HTMX</strong>: For interactive web functionality without complex JavaScript</li>
<li><strong>Pico CSS</strong>: Lightweight CSS framework included with FastHTML by default</li>
<li><strong>Typer</strong>: For building the CLI interface</li>
<li><strong>Rich</strong>: For terminal formatting and display</li>
</ul>
<h3 id="83-development-tools">8.3 Development Tools</h3>
<p>The project utilizes several modern Python development tools:</p>
<ul>
<li><strong>uv</strong>: Fast package installer and virtual environment manager</li>
<li><strong>ruff</strong>: Fast Python linter and formatter</li>
<li><strong>pytest</strong>: Testing framework</li>
<li><strong>mkdocs</strong>: Documentation generation</li>
</ul>
<h3 id="84-configuration">8.4 Configuration</h3>
<p>The system is highly configurable through YAML files:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># System configuration</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nt">system</span><span class="p">:</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">  </span><span class="nt">persistence_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.curriculum_curator&quot;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="nt">output_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;output&quot;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="nt">log_level</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;INFO&quot;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># LLM providers configuration</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="nt">llm</span><span class="p">:</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="nt">default_provider</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ollama&quot;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="nt">providers</span><span class="p">:</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="nt">anthropic</span><span class="p">:</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(ANTHROPIC_API_KEY)&quot;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;claude-3-haiku&quot;</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.75</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">        </span><span class="nt">claude-3-haiku</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">        </span><span class="nt">claude-3-opus</span><span class="p">:</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">          </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">            </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15.00</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">75.00</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="nt">openai</span><span class="p">:</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(OPENAI_API_KEY)&quot;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-3.5-turbo&quot;</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.50</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.50</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">        </span><span class="nt">gpt-3.5-turbo</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w">        </span><span class="nt">gpt-4-turbo</span><span class="p">:</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="w">          </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="w">            </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.00</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="w">            </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.00</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="w">    </span><span class="nt">ollama</span><span class="p">:</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="w">      </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:11434&quot;</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llama3&quot;</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="w">        </span><span class="nt">llama3</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="w">        </span><span class="nt">mistral</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="w">    </span><span class="nt">groq</span><span class="p">:</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(GROQ_API_KEY)&quot;</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llama3-8b-8192&quot;</span>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.10</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.30</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a><span class="w">        </span><span class="nt">llama3-8b-8192</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a><span class="w">    </span><span class="nt">gemini</span><span class="p">:</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;env(GOOGLE_API_KEY)&quot;</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gemini-pro&quot;</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a><span class="w">      </span><span class="nt">cost_per_1k_tokens</span><span class="p">:</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.50</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.50</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a><span class="w">        </span><span class="nt">gemini-pro</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a><span class="c1"># Prompt registry configuration</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a><span class="nt">prompts</span><span class="p">:</span>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a><span class="w">  </span><span class="nt">base_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;./prompts&quot;</span>
<a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>
<a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a><span class="c1"># Validation configuration</span>
<a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a><span class="nt">validation</span><span class="p">:</span>
<a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a><span class="w">  </span><span class="nt">similarity</span><span class="p">:</span>
<a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.85</span>
<a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a><span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;all-MiniLM-L6-v2&quot;</span>
<a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a>
<a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a><span class="w">  </span><span class="nt">structure</span><span class="p">:</span>
<a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a><span class="w">    </span><span class="nt">slides</span><span class="p">:</span>
<a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a><span class="w">      </span><span class="nt">min_sections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a><span class="w">      </span><span class="nt">required_sections</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;objectives&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;summary&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a>
<a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a><span class="w">  </span><span class="nt">readability</span><span class="p">:</span>
<a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a><span class="w">    </span><span class="nt">max_avg_sentence_length</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25</span>
<a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a><span class="w">    </span><span class="nt">min_flesch_reading_ease</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>
<a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a><span class="c1"># Remediation configuration</span>
<a id="__codelineno-18-85" name="__codelineno-18-85" href="#__codelineno-18-85"></a><span class="nt">remediation</span><span class="p">:</span>
<a id="__codelineno-18-86" name="__codelineno-18-86" href="#__codelineno-18-86"></a><span class="w">  </span><span class="nt">content_merger</span><span class="p">:</span>
<a id="__codelineno-18-87" name="__codelineno-18-87" href="#__codelineno-18-87"></a><span class="w">    </span><span class="nt">similarity_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.8</span>
<a id="__codelineno-18-88" name="__codelineno-18-88" href="#__codelineno-18-88"></a>
<a id="__codelineno-18-89" name="__codelineno-18-89" href="#__codelineno-18-89"></a><span class="w">  </span><span class="nt">sentence_splitter</span><span class="p">:</span>
<a id="__codelineno-18-90" name="__codelineno-18-90" href="#__codelineno-18-90"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-18-91" name="__codelineno-18-91" href="#__codelineno-18-91"></a>
<a id="__codelineno-18-92" name="__codelineno-18-92" href="#__codelineno-18-92"></a><span class="c1"># Output configuration</span>
<a id="__codelineno-18-93" name="__codelineno-18-93" href="#__codelineno-18-93"></a><span class="nt">output</span><span class="p">:</span>
<a id="__codelineno-18-94" name="__codelineno-18-94" href="#__codelineno-18-94"></a><span class="w">  </span><span class="nt">html_options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--template=default&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--css=styles.css&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-95" name="__codelineno-18-95" href="#__codelineno-18-95"></a><span class="w">  </span><span class="nt">pdf_options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--pdf-engine=wkhtmltopdf&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-96" name="__codelineno-18-96" href="#__codelineno-18-96"></a><span class="w">  </span><span class="nt">docx_options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--reference-doc=template.docx&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-18-97" name="__codelineno-18-97" href="#__codelineno-18-97"></a><span class="w">  </span><span class="nt">slides_options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--variable=theme:moon&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h2 id="9-deployment-strategy">9. Deployment Strategy</h2>
<p>CurriculumCurator can be deployed in several ways to meet different user needs.</p>
<h3 id="91-package-installation">9.1 Package Installation</h3>
<p>The primary distribution method is via pip:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>pip<span class="w"> </span>install<span class="w"> </span>curriculum-curator
</code></pre></div>
<p>This installs the core package and its Python dependencies. Users will need to install Pandoc separately for output format conversion.</p>
<h3 id="92-docker-container">9.2 Docker Container</h3>
<p>For consistent deployment across environments, a Docker container is provided:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10-slim</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c"># Install Pandoc and other dependencies</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span>pandoc<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span>wkhtmltopdf<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="c"># Install curriculum-curator</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>/app
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="c"># Create volume mount points</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="k">VOLUME</span><span class="w"> </span><span class="s">/data/prompts</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="k">VOLUME</span><span class="w"> </span><span class="s">/data/output</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="k">VOLUME</span><span class="w"> </span><span class="s">/data/sessions</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="c"># Set environment variables</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">CURATOR_CONFIG</span><span class="o">=</span>/data/config.yaml
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="c"># Set entrypoint</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;curator&quot;</span><span class="p">]</span>
</code></pre></div>
<p>This allows users to run CurriculumCurator with all dependencies pre-installed:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>./prompts:/data/prompts<span class="w"> </span>-v<span class="w"> </span>./output:/data/output<span class="w"> </span>-v<span class="w"> </span>./config.yaml:/data/config.yaml<span class="w"> </span>curriculum-curator<span class="w"> </span>run<span class="w"> </span>standard_course<span class="w"> </span>--var<span class="w"> </span><span class="nv">course_title</span><span class="o">=</span><span class="s2">&quot;Python Programming&quot;</span>
</code></pre></div>
<h3 id="93-github-releases">9.3 GitHub Releases</h3>
<p>Pre-built wheels and installation instructions are provided via GitHub Releases, making it easy for users to install specific versions.</p>
<h3 id="94-documentation">9.4 Documentation</h3>
<p>Comprehensive documentation is hosted on GitHub Pages using mkdocs, including:</p>
<ul>
<li>Installation instructions</li>
<li>Configuration guide</li>
<li>Prompt authoring guidelines</li>
<li>Workflow examples</li>
<li>API reference</li>
<li>CLI command reference</li>
</ul>
<h3 id="95-local-development">9.5 Local Development</h3>
<p>For developers contributing to the project or extending it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Clone the repository</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/organization/curriculum-curator.git
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nb">cd</span><span class="w"> </span>curriculum-curator
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="c1"># Create virtual environment and install in development mode</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>uv<span class="w"> </span>venv
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="nb">source</span><span class="w"> </span>.venv/bin/activate
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="c1"># Run tests</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>pytest
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="c1"># Run linter and formatter</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>ruff<span class="w"> </span>check<span class="w"> </span>.
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>ruff<span class="w"> </span>format<span class="w"> </span>.
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="c1"># Build documentation</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>mkdocs<span class="w"> </span>build
</code></pre></div>
<h2 id="10-component-interaction-diagram">10. Component Interaction Diagram</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>graph TD
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    subgraph User_Configuration
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>        direction LR
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>        Config[&quot;YAML Config Files&quot;]
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>        UserPrompts[&quot;prompts/*.txt&quot;]
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    end
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    subgraph CurriculumCurator_Core
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>        direction TB
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>        WorkflowEngine[&quot;Workflow Engine&quot;]
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>        PromptRegistry[&quot;Prompt Registry&quot;]
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>        LLMLayer[&quot;LLM Integration Layer&lt;br/&gt;(using LiteLLM)&quot;]
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>        Transformation[&quot;Content Transformation Layer&quot;]
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>        Validation[&quot;Validation Framework&quot;]
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>        Remediation[&quot;Remediation System&quot;]
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>        Output[&quot;Output Production&quot;]
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>        Persistence[&quot;Persistence Manager&quot;]
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    end
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>    subgraph External_Systems
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>        direction RL
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>        LLMAPIs[&quot;LLM APIs&lt;br/&gt;(OpenAI, Claude, Gemini, Groq, Ollama)&quot;]
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>        Pandoc[&quot;Pandoc/Quarto&quot;]
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>    end
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    subgraph Interfaces
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>        direction TB
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>        CLI[&quot;CLI Interface&quot;]
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>        API[&quot;Python API&quot;]
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>        WebUI[&quot;Web Interface (Future)&quot;]
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>        TUI[&quot;TUI Interface (Future)&quot;]
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>    end
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>    %% Interactions %%
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>    Config --&gt; WorkflowEngine
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>    Config --&gt; LLMLayer
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>    Config --&gt; Validation
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>    Config --&gt; Remediation
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>    Config --&gt; Output
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>    Config --&gt; Persistence
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>    UserPrompts --&gt; PromptRegistry
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>    WorkflowEngine -- &quot;Reads Steps&quot; --&gt; Config
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>    WorkflowEngine -- &quot;Gets Prompt Template&quot; --&gt; PromptRegistry
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>    WorkflowEngine -- &quot;Requests Generation&quot; --&gt; LLMLayer
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>    LLMLayer -- &quot;Returns Raw Content&quot; --&gt; WorkflowEngine
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>    WorkflowEngine -- &quot;Sends for Transformation&quot; --&gt; Transformation
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>    Transformation -- &quot;Returns Structured Content&quot; --&gt; WorkflowEngine
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>    WorkflowEngine -- &quot;Sends Content for Validation&quot; --&gt; Validation
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>    Validation -- &quot;Returns Validation Issues&quot; --&gt; WorkflowEngine
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>    WorkflowEngine -- &quot;Sends Content+Issues for Remediation&quot; --&gt; Remediation
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>    Remediation -- &quot;Returns Remediated Content&quot; --&gt; WorkflowEngine
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>    WorkflowEngine -- &quot;Manages Context&quot; --&gt; WorkflowEngine
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>    WorkflowEngine -- &quot;Sends Final Content&quot; --&gt; Output
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>    WorkflowEngine -- &quot;Persists State&quot; --&gt; Persistence
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>    PromptRegistry -- &quot;Loads Prompts&quot; --&gt; UserPrompts
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>    LLMLayer -- &quot;Gets Provider Config&quot; --&gt; Config
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>    LLMLayer -- &quot;Calls External API&quot; --&gt; LLMAPIs
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>    Validation -- &quot;Gets Rules&quot; --&gt; Config
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>    Output -- &quot;Calls External Tool&quot; --&gt; Pandoc
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>    CLI --&gt; WorkflowEngine
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>    API --&gt; WorkflowEngine
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>    WebUI --&gt; WorkflowEngine
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>    TUI --&gt; WorkflowEngine
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>    Output --&gt; GeneratedFiles[&quot;Generated Curriculum Files&quot;]
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>    Persistence --&gt; SessionFiles[&quot;Session Records&quot;]
</code></pre></div>
<h2 id="11-benefits-of-this-approach">11. Benefits of This Approach</h2>
<ol>
<li><strong>Simplicity (User)</strong>: Filesystem prompts with standard YAML front matter are easy to manage; Markdown focus is intuitive.</li>
<li><strong>Maintainability</strong>: Clear separation of concerns; LLM broker handles provider complexity; standard front matter parsing.</li>
<li><strong>Flexibility</strong>: Highly configurable via YAML; extensible architecture.</li>
<li><strong>Performance</strong>: Asynchronous processing for efficient LLM usage.</li>
<li><strong>Quality</strong>: Built-in validation and remediation steps.</li>
<li><strong>Output Versatility</strong>: Leverages powerful external tools (Pandoc) for broad format support from a common Markdown base.</li>
<li><strong>Cost Transparency</strong>: Token usage and cost tracking at every step.</li>
<li><strong>Provider Independence</strong>: Support for multiple LLM providers with seamless fallbacks.</li>
</ol>
<h2 id="12-conclusion">12. Conclusion</h2>
<p>This design document outlines a comprehensive architecture for CurriculumCurator, an educational content workflow orchestration tool. The system leverages the power of Large Language Models while providing a flexible, configurable framework that can be adapted to various educational content creation needs.</p>
<p>The implementation follows modern Python development practices, with clear separation of concerns, robust error handling, and a focus on usability. By combining prompt-centric content generation with workflow-driven processes, CurriculumCurator streamlines the creation of high-quality educational materials while maintaining full control and transparency.# CurriculumCurator: Comprehensive Design Document</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.indexes", "content.code.copy", "content.tabs.link"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>